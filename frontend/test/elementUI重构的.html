<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek ChatBox Clone - Element Plus é‡æ„ç‰ˆ</title>
    <!-- å¼•å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- å¼•å…¥ Element Plus æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <!-- å¼•å…¥ Element Plus ç»„ä»¶åº“ -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- å¼•å…¥ Element Plus å›¾æ ‡ -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- å¼•å…¥ Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
</head>
<body>

<div id="app">
    <el-config-provider>
        <!-- ç™»å½•å¯¹è¯æ¡† -->
        <el-dialog v-model="showLoginDialog" :title="isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ'" width="400px" :close-on-click-modal="false" :show-close="false">
            <el-form :model="authForm" label-position="top">
                <el-form-item label="ç”¨æˆ·å">
                    <el-input v-model="authForm.username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å"></el-input>
                </el-form-item>
                <el-form-item label="å¯†ç ">
                    <el-input v-model="authForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " show-password></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="toggleAuthMode">{{ isLoginMode ? 'å»æ³¨å†Œ' : 'å»ç™»å½•' }}</el-button>
                <el-button type="primary" @click="handleAuth">{{ isLoginMode ? 'ç™»å½•' : 'æ³¨å†Œ' }}</el-button>
            </template>
        </el-dialog>

        <!-- ä¸»å¸ƒå±€ -->
        <el-container v-if="isLoggedIn" style="height: 100%;">
            <!-- å·¦ä¾§è¾¹æ  -->
            <el-aside :width="sidebarCollapsed ? '64px' : '260px'">
                <div class="sidebar-header">
                    <div class="logo">
                        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="var(--el-color-primary)" d="M864 256H160C106.912 256 64 298.912 64 352v448c0 53.088 42.912 96 96 96h704c53.088 0 96-42.912 96-96V352c0-53.088-42.912-96-96-96zM480 704a128 128 0 1 1 128-128c0 70.848-57.152 128-128 128zm32-256a128 128 0 1 1-128-128c70.848 0 128 57.152 128 128z"></path></svg>
                        <span v-show="!sidebarCollapsed">DeepSeek</span>
                    </div>
                    <el-button :icon="sidebarCollapsed ? ElementPlusIconsVue.Expand : ElementPlusIconsVue.Fold" text circle @click="toggleSidebar"></el-button>
                </div>

                <div class="sidebar-content">
                    <el-button class="new-chat-btn" :icon="ElementPlusIconsVue.Plus" @click="createNewConversation" :disabled="sidebarCollapsed">
                        å¼€å¯æ–°å¯¹è¯
                    </el-button>

                    <el-scrollbar class="history-list">
                        <el-menu :default-active="currentConversationId" @select="loadConversation" :collapse="sidebarCollapsed">
                            <el-menu-item-group v-for="group in conversationGroups" :key="group.title" :title="group.title">
                                <el-menu-item v-for="conversation in group.conversations" :key="conversation.id" :index="conversation.id.toString()">
                                    <el-icon><el-icon-chat-dot-round /></el-icon>
                                    <template #title>{{ conversation.title }}</template>
                                </el-menu-item>
                            </el-menu-item-group>
                        </el-menu>
                    </el-scrollbar>
                </div>

                <div class="sidebar-footer">
                    <div class="user-profile">
                        <el-avatar size="small" style="background-color: #facc15">ğŸ§</el-avatar>
                        <span v-show="!sidebarCollapsed">{{ currentUser.username }}</span>
                    </div>
                    <el-dropdown v-show="!sidebarCollapsed" trigger="click">
                        <el-button :icon="ElementPlusIconsVue.MoreFilled" text circle></el-button>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item @click="logout">é€€å‡ºç™»å½•</el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
            </el-aside>

            <!-- å³ä¾§ä¸»èŠå¤©åŒº -->
            <el-main class="chat-area">
                <!-- åŠŸèƒ½å¼€å…³ -->
                <div style="padding: 0 24px 16px 24px;">
                    <el-check-tag :checked="features.deepThinking" @change="toggleFeature('deepThinking')" style="margin-right: 8px;">
                        ğŸ§  æ·±åº¦æ€è€ƒ
                    </el-check-tag>
                    <el-check-tag :checked="features.webSearch" @change="toggleFeature('webSearch')">
                        ğŸŒ è”ç½‘æœç´¢
                    </el-check-tag>
                </div>

                <!-- èŠå¤©æ¶ˆæ¯æˆ–æ¬¢è¿ç•Œé¢ -->
                <el-scrollbar v-if="currentMessages.length > 0" class="chat-messages" ref="messagesScrollbar">
                    <div ref="messagesContainer">
                        <div v-for="message in currentMessages" :key="message.id" class="message" :class="message.role">
                            <div class="message-avatar">{{ message.role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–' }}</div>
                            <div class="message-content" v-html="renderMarkdown(message.content)"></div>
                        </div>
                        <div v-if="isTyping" class="message assistant">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message-content">
                                <div class="typing-indicator"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>
                </el-scrollbar>
                <div v-else class="welcome-screen">
                    <div class="welcome-content">
                        <div class="logo">
                            <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path fill="var(--el-color-primary)" d="M864 256H160C106.912 256 64 298.912 64 352v448c0 53.088 42.912 96 96 96h704c53.088 0 96-42.912 96-96V352c0-53.088-42.912-96-96-96zM480 704a128 128 0 1 1 128-128c0 70.848-57.152 128-128 128zm32-256a128 128 0 1 1-128-128c70.848 0 128 57.152 128 128z"></path></svg>
                        </div>
                        <h1 style="font-size: 22px; font-weight: 500;">ä»Šå¤©æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ ?</h1>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="input-wrapper">
                    <div class="input-box">
                        <el-input
                                v-model="inputMessage"
                                type="textarea"
                                :autosize="{ minRows: 1, maxRows: 5 }"
                                placeholder="ç»™ DeepSeek å‘é€æ¶ˆæ¯"
                                @keydown.enter.prevent="handleSendMessage"
                        ></el-input>
                        <el-button
                                class="send-button"
                                type="primary"
                                circle
                                :icon="ElementPlusIconsVue.Promotion"
                                @click="handleSendMessage"
                                :disabled="!inputMessage.trim() || isTyping"
                        ></el-button>
                    </div>
                </div>
            </el-main>
        </el-container>
    </el-config-provider>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;
    const { ElMessage } = ElementPlus;

    // APIæœåŠ¡ç±» (ä¸åŸä»£ç ç›¸åŒï¼Œæ­¤å¤„çœç•¥ä»¥ä¿æŒç®€æ´)
    class ApiService {
        // ... (æ­¤å¤„çœç•¥ä¸åŸä»£ç å®Œå…¨ç›¸åŒçš„ ApiService ç±»)
        // è¯·å°†æ‚¨åŸä»£ç ä¸­çš„ ApiService ç±»å®Œæ•´åœ°å¤åˆ¶åˆ°è¿™é‡Œ
    }
    const apiService = new ApiService();

    const app = createApp({
        setup() {
            // å“åº”å¼æ•°æ®
            const isLoggedIn = ref(false);
            const showLoginDialog = ref(true);
            const isLoginMode = ref(true);
            const authForm = ref({ username: '', password: '' });
            const currentUser = ref(null);
            const sidebarCollapsed = ref(false);
            const inputMessage = ref('');
            const isTyping = ref(false);
            const currentConversationId = ref(null);
            const currentMessages = ref([]);
            const conversations = ref([]);
            const features = ref({ deepThinking: false, webSearch: false });

            const messagesScrollbar = ref(null);
            const messagesContainer = ref(null);

            // è®¡ç®—å±æ€§
            const conversationGroups = computed(() => {
                // ... (ä¸åŸä»£ç ç›¸åŒ)
            });

            // æ–¹æ³•
            const toggleAuthMode = () => {
                isLoginMode.value = !isLoginMode.value;
                authForm.value = { username: '', password: '' };
            };

            const handleAuth = async () => {
                if (!authForm.value.username || !authForm.value.password) {
                    ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                try {
                    let response;
                    if (isLoginMode.value) {
                        response = await apiService.login(authForm.value);
                        currentUser.value = await apiService.getCurrentUser();
                    } else {
                        response = await apiService.register(authForm.value);
                        currentUser.value = response;
                        await apiService.login(authForm.value);
                    }
                    isLoggedIn.value = true;
                    showLoginDialog.value = false;
                    localStorage.setItem('user', JSON.stringify(currentUser.value));
                    loadConversations();
                    ElMessage.success(isLoginMode.value ? 'ç™»å½•æˆåŠŸ' : 'æ³¨å†ŒæˆåŠŸ');
                } catch (error) {
                    ElMessage.error(error.message || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            const logout = () => {
                isLoggedIn.value = false;
                showLoginDialog.value = true;
                currentUser.value = null;
                // ... (é‡ç½®å…¶ä»–çŠ¶æ€)
                localStorage.removeItem('user');
                apiService.setToken(null);
            };

            const toggleSidebar = () => sidebarCollapsed.value = !sidebarCollapsed.value;
            const toggleFeature = (feature) => features.value[feature] = !features.value[feature];
            const createNewConversation = () => {
                currentConversationId.value = null;
                currentMessages.value = [];
            };

            const loadConversation = async (conversationId) => {
                if (!conversationId) return;
                currentConversationId.value = conversationId;
                // ... (åŠ è½½æ¶ˆæ¯çš„é€»è¾‘ä¸åŸä»£ç ç›¸åŒ)
            };

            const loadConversations = async () => {
                // ... (åŠ è½½ä¼šè¯åˆ—è¡¨çš„é€»è¾‘ä¸åŸä»£ç ç›¸åŒ)
            };

            const handleSendMessage = async () => {
                if (!inputMessage.value.trim() || isTyping.value) return;
                // ... (å‘é€æ¶ˆæ¯å’Œå¤„ç†æµå¼å“åº”çš„é€»è¾‘ä¸åŸä»£ç ç›¸åŒ)
                // æ³¨æ„ï¼šåœ¨æ¥æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œéœ€è¦è°ƒç”¨ scrollToBottom æ–¹æ³•
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    if (messagesScrollbar.value && messagesContainer.value) {
                        messagesScrollbar.value.setScrollTop(messagesContainer.value.scrollHeight);
                    }
                });
            };

            const renderMarkdown = (content) => {
                return window.marked ? window.marked.parse(content) : content;
            };

            // ç”Ÿå‘½å‘¨æœŸé’©å­
            onMounted(async () => {
                const savedUser = localStorage.getItem('user');
                const savedToken = localStorage.getItem('token');
                if (savedUser && savedToken) {
                    try {
                        currentUser.value = JSON.parse(savedUser);
                        apiService.setToken(savedToken);
                        await apiService.getCurrentUser();
                        isLoggedIn.value = true;
                        showLoginDialog.value = false;
                        loadConversations();
                    } catch (error) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('token');
                        apiService.setToken(null);
                    }
                }
            });

            return {
                // ... (è¿”å›æ‰€æœ‰éœ€è¦ç»‘å®šçš„æ•°æ®å’Œæ–¹æ³•)
                isLoggedIn, showLoginDialog, isLoginMode, authForm, currentUser,
                sidebarCollapsed, inputMessage, isTyping, currentConversationId,
                currentMessages, conversationGroups, features,
                messagesScrollbar, messagesContainer,
                toggleAuthMode, handleAuth, logout, toggleSidebar, toggleFeature,
                createNewConversation, loadConversation, handleSendMessage, renderMarkdown
            };
        }
    });

    // æŒ‚è½½æ‰€æœ‰ Element Plus å›¾æ ‡
    for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
    }

    app.use(ElementPlus);
    app.mount('#app');

</script>

</body>
</html>
